<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ConvertServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jsgenerator</a> &gt; <a href="index.source.html" class="el_package">com.osscameroon.jsgenerator.service</a> &gt; <span class="el_source">ConvertServiceImpl.java</span></div><h1>ConvertServiceImpl.java</h1><pre class="source lang-java linenums">package com.osscameroon.jsgenerator.service;

import static com.osscameroon.jsgenerator.util.Constants.HTML_SRC_DIR;
import static com.osscameroon.jsgenerator.util.Constants.JS_DEST_DIR;

import java.io.File;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.List;
import java.util.logging.Level;
import java.util.logging.Logger;

import org.jsoup.Jsoup;
import org.jsoup.nodes.Attribute;
import org.jsoup.nodes.Attributes;
import org.jsoup.nodes.Element;
import org.jsoup.nodes.Node;
import org.jsoup.nodes.TextNode;
import org.jsoup.parser.Parser;
import org.jsoup.parser.Tag;

import com.osscameroon.jsgenerator.exception.DuplicatedHTMLFileNameException;
import com.osscameroon.jsgenerator.exception.EmptyHTMLFilesListException;
import com.osscameroon.jsgenerator.exception.HTMLFileNotFoundException;
import com.osscameroon.jsgenerator.exception.HTMLUnknownElementException;
import com.osscameroon.jsgenerator.exception.IncorrectHTMLFileNameException;
import com.osscameroon.jsgenerator.exception.NoHTMLCodeException;
import com.osscameroon.jsgenerator.exception.NoHTMLFileNameException;
import com.osscameroon.jsgenerator.model.JSElement;
import com.osscameroon.jsgenerator.model.JSVariableDeclaration;
import com.osscameroon.jsgenerator.util.FileUtil;

/**
 * Provides an implementation of {@link ConvertService} interface.
 *
 * @author Fanon Jupkwo
 * @author Elroy Kanye
 *
 */
public class ConvertServiceImpl implements ConvertService {

<span class="fc" id="L43">    private static final Logger logger = Logger.getLogger(ConvertServiceImpl.class.getName());</span>

    private JSVariableDeclaration jsVariableDeclaration;

<span class="fc" id="L47">    public ConvertServiceImpl(JSVariableDeclaration jsVariableDeclaration) {</span>

<span class="fc" id="L49">	this.jsVariableDeclaration = jsVariableDeclaration;</span>

<span class="fc" id="L51">    }</span>

    /**
     * Tags present in the document to convert
     */

<span class="fc" id="L57">    private List&lt;String&gt; usedTags = new ArrayList&lt;&gt;();</span>

    /**
     * {@inheritDoc}
     *
     *
     */

    @Override
    public String convert(String content) throws NoHTMLCodeException {

<span class="pc bpc" id="L68" title="1 of 2 branches missed.">	if (content == null) {</span>

<span class="nc" id="L70">	    throw new NoHTMLCodeException(&quot;There is no html content.&quot;);</span>
	}

<span class="pc bpc" id="L73" title="1 of 2 branches missed.">	if (content.isBlank()) {</span>

<span class="nc" id="L75">	    throw new NoHTMLCodeException(&quot;The content has nothing to translate.&quot;);</span>

	}

<span class="fc" id="L79">	Element htmlDoc = Jsoup.parse(content, &quot;&quot;, Parser.xmlParser());</span>

	/*
	 * trim() is added to delete leading and trailing space. Before adding that, the
	 * generated Js code contained these not important spaces. It was difficult to
	 * test this method.
	 */

<span class="fc" id="L87">	String result = parseElement(htmlDoc).trim();</span>

	/*
	 * Without this line, the result of convert method with same parameter changed
	 * everytime if we used the same object to call this function. The result of
	 * convert with same parameter was constant if we used different objects. To
	 * avoid this issue, we were forced to create different objects but that's not
	 * how it should be done.
	 *
	 * Now, the program clears the list of used tags in order to always get an empty
	 * list when we call this method.
	 */
<span class="fc" id="L99">	usedTags.clear();</span>

<span class="fc" id="L101">	return result;</span>
    }

    /**
     * {@inheritDoc}
     *
     *
     */

    @Override
    public void convertHtmlFiletoJsFileFromCommandLineInterface(String htmlFileName)
	    throws NoHTMLFileNameException, IncorrectHTMLFileNameException, HTMLFileNotFoundException {

<span class="nc bnc" id="L114" title="All 2 branches missed.">	if (htmlFileName == null) {</span>

<span class="nc" id="L116">	    throw new NoHTMLFileNameException(&quot;There is no Html file name.&quot;);</span>
	}

<span class="nc bnc" id="L119" title="All 2 branches missed.">	if (!isHTMLFileNameCorrect(htmlFileName)) {</span>

<span class="nc" id="L121">	    throw new IncorrectHTMLFileNameException(&quot;The HTML file's name \&quot;&quot; + htmlFileName + &quot;\&quot; is incorrect.&quot;);</span>
	}

	// get the full supposed path to the html file

<span class="nc" id="L126">	String pathToHtml = HTML_SRC_DIR.getFolder().concat(htmlFileName);</span>

<span class="nc" id="L128">	File htmlFile = new File(pathToHtml);</span>

<span class="nc bnc" id="L130" title="All 2 branches missed.">	if (!htmlFile.exists()) {</span>

<span class="nc" id="L132">	    throw new HTMLFileNotFoundException(&quot;Html file \&quot;&quot; + htmlFileName + &quot;\&quot; not found&quot;);</span>
	}

	// Use log instead of system.out.println to show steps

	/*
	 * If HTML_SRC_DIR folder doesn't exist then it will create them
	 *
	 * new File(HTML_SRC_DIR.getFolder()).createNewFile();
	 */

<span class="nc" id="L143">	logger.log(Level.INFO, &quot; **** Converting &quot; + htmlFileName + &quot; to js file **** &quot;);</span>

	/*
	 * By default, the input folder exists but the output folder don't. So, if
	 * JS_DEST_DIR folder doesn't exist then it will be created in order to receive
	 * generated Js files. If this output folder doesn't exist when this method is
	 * called, an exception will be thrown.
	 */

<span class="nc" id="L152">	File outputFolder = new File(JS_DEST_DIR.getFolder());</span>

<span class="nc bnc" id="L154" title="All 4 branches missed.">	if (outputFolder.exists() &amp;&amp; outputFolder.isDirectory()) {</span>

	} else {

<span class="nc" id="L158">	    outputFolder.mkdir();</span>
	}

	// get the full supposed path to the js file

<span class="nc" id="L163">	String jsFilePath = JS_DEST_DIR.getFolder().concat(htmlFileName.split(&quot;.html&quot;)[0] + &quot;.js&quot;);</span>

<span class="nc" id="L165">	String htmlContent = FileUtil.readHtmlFile(pathToHtml).toString();</span>

<span class="nc" id="L167">	String jsContent = convert(htmlContent);</span>

<span class="nc" id="L169">	FileUtil.writeJsFile(jsContent, jsFilePath);</span>

<span class="nc" id="L171">	logger.log(Level.INFO, &quot; **** Conversion complete **** &quot;);</span>

<span class="nc" id="L173">    }</span>

    /**
     * {@inheritDoc}
     *
     *
     */

    @Override
    public void convertHtmlFiletoJsFileFromCommandLineInterface(String[] args)
	    throws NoHTMLFileNameException, EmptyHTMLFilesListException, DuplicatedHTMLFileNameException {

<span class="nc bnc" id="L185" title="All 2 branches missed.">	if (args == null) {</span>

<span class="nc" id="L187">	    throw new NoHTMLFileNameException(&quot;There is no list of Html files.&quot;);</span>

	}

<span class="nc bnc" id="L191" title="All 2 branches missed.">	if (args.length == 0) {</span>

<span class="nc" id="L193">	    throw new EmptyHTMLFilesListException(&quot;The list of Html files to translate is empty&quot;);</span>
	}

<span class="nc" id="L196">	List&lt;String&gt; argList = Arrays.asList(args);</span>

	// TODO: verify that all files are named correctly with .html, create a method
	// in ConvertService

	// throw exception because there are list 2 files with same name
	// inform the user and work with unique file names

<span class="nc" id="L204">	argList.stream().forEach(s -&gt; {</span>

<span class="nc bnc" id="L206" title="All 2 branches missed.">	    if (Collections.frequency(argList, s) == 1) {</span>

<span class="nc" id="L208">		convertHtmlFiletoJsFileFromCommandLineInterface(s);</span>

	    } else {

		// TODO: throw exception because there are 2 files with same name

<span class="nc" id="L214">		logger.log(Level.INFO, &quot;There are at least 2 files with same name on CLI : &quot; + s);</span>

<span class="nc" id="L216">		throw new DuplicatedHTMLFileNameException(&quot;There are at least 2 files with same name on CLI : &quot; + s);</span>

	    }
<span class="nc" id="L219">	});</span>

<span class="nc" id="L221">    }</span>

    /**
     * {@inheritDoc}
     *
     *
     */

    // Will be implemented soon

    @Override
    public void convertHtmlFiletoJsFileFromWeb(String htmlFileName, String outputFolder) {
<span class="nc" id="L233">	throw new UnsupportedOperationException();</span>
    }

    /**
     * Goes through the Jsoup Elements and converts them to JSElement objects.
     *
     * @param element Jsoup Element
     * @return the generated code in JS
     * @throws HTMLUnknownElementException if an invalid HTML tag is used
     *
     */

    private String parseElement(Element element) throws HTMLUnknownElementException {

<span class="fc" id="L247">	logger.log(Level.INFO, &quot; **** METHOD -- parseElement(Element element) -- Analyzing element : tagName = &quot;</span>
<span class="fc" id="L248">		+ element.tagName() + &quot; -&gt; &quot; + element + &quot;\n&quot; + &quot;---------------&quot; + &quot;\n&quot;);</span>

	/*
	 * If the element is not the root and is unknown then there is a problem.
	 * Without the first condition &quot;!element.root().equals(element)&quot;, there will be
	 * an exception thrown if the element is the root
	 */

<span class="fc bfc" id="L256" title="All 4 branches covered.">	if (!element.root().equals(element) &amp;&amp; !element.tag().isKnownTag()) {</span>

<span class="fc" id="L258">	    throw new HTMLUnknownElementException(</span>
<span class="fc" id="L259">		    &quot;\&quot;&quot; + element + &quot; -&gt; &quot; + element.tagName() + &quot;\&quot;&quot; + &quot; is not a valid HTML Element.&quot;);</span>
	}

<span class="fc" id="L262">	StringBuilder generatedCode = new StringBuilder();</span>

<span class="fc bfc" id="L264" title="All 2 branches covered.">	for (Element child : element.children()) {</span>
<span class="fc" id="L265">	    generatedCode.append(parseElement(child)).append(&quot;\n&quot;); // recursive</span>

<span class="fc" id="L267">	    JSElement childJsElement = new JSElement(child, jsVariableDeclaration);</span>

	    // parse this current element

<span class="fc" id="L271">	    generatedCode.append(parse(usedTags, childJsElement));</span>

	    // append this current element's children code to parent code
<span class="fc" id="L274">	    String appends = appendChild(childJsElement);</span>

<span class="fc bfc" id="L276" title="All 2 branches covered.">	    if (!appends.equals(&quot;&quot;)) {</span>
<span class="fc" id="L277">		generatedCode.append(appends);</span>
	    }
<span class="fc" id="L279">	}</span>
<span class="fc" id="L280">	return generatedCode.toString();</span>
    }

    /**
     * For this element, it returns the code to append the element to the parent
     *
     * @param usedTags  List of used tags in the document
     * @param jsElement
     * @return code to append the element to the parent
     * @throws HTMLUnknownElementException if an invalid HTML tag is used
     */

    private String parse(List&lt;String&gt; usedTags, JSElement jsElement) throws HTMLUnknownElementException {

<span class="pc bpc" id="L294" title="1 of 2 branches missed.">	if (!jsElement.getElement().tag().isKnownTag()) {</span>

<span class="nc" id="L296">	    throw new HTMLUnknownElementException(</span>
<span class="nc" id="L297">		    &quot;\&quot;&quot; + jsElement.getElement().tagName() + &quot;\&quot;&quot; + &quot; is not a valid HTML Element.&quot;);</span>
	}

	// search tag name among used tags
<span class="fc" id="L301">	usedTags.stream().filter(s -&gt; s.equals(jsElement.getElement().tagName()))</span>
<span class="fc" id="L302">		.forEach(s -&gt; jsElement.getElement().tagName(jsElement.getElement().tagName() + &quot;_&quot;));</span>

	// tag name
<span class="fc" id="L305">	String tag = jsElement.getElement().tagName();</span>

<span class="fc" id="L307">	usedTags.add(tag);</span>

	/*
	 * Tag name should not contain _ TODO: Check that
	 */

<span class="fc" id="L313">	StringBuilder generatedCode = new StringBuilder(jsElement.getJSVariableDeclaration().getKeyword() + &quot; &quot; + tag</span>
<span class="fc" id="L314">		+ &quot; = document.createElement(\&quot;&quot; + tag.replace(&quot;_&quot;, &quot;&quot;) + &quot;\&quot;);\n&quot;);</span>

	// attributes: attributes of the element
<span class="fc" id="L317">	Attributes attributes = jsElement.getElement().attributes();</span>

	// Given an element, it adds the attributes to the element

<span class="fc bfc" id="L321" title="All 2 branches covered.">	for (Attribute attribute : attributes) {</span>
<span class="fc" id="L322">	    generatedCode.append(tag).append(&quot;.setAttribute(\&quot;&quot;).append(attribute.getKey()).append(&quot;\&quot;, \&quot;&quot;)</span>
<span class="fc" id="L323">		    .append(attribute.getValue()).append(&quot;\&quot;);\n&quot;);</span>
<span class="fc" id="L324">	}</span>

<span class="fc" id="L326">	return generatedCode.toString();</span>
    }

    /**
     * For this element, it returns the code to append the child of type Element or
     * TextNode
     *
     * @param jsElement
     * @return code to append the child of type Element or TextNode
     */

    private String appendChild(JSElement jsElement) {

<span class="fc" id="L339">	StringBuilder generatedCode = new StringBuilder();</span>

	/*
	 * Please, think twice before deleting this log, it helps to understand what is
	 * going on under the hood. It is really helpful to understand that there is a
	 * bug in Jsoup library.
	 *
	 * Let's take an example,
	 *
	 *
	 * &lt;input type=&quot;text&quot;&gt; &lt;img src=&quot;#URL&quot; alt=&quot;image&quot;&gt;
	 *
	 * ------------------------------------------------------
	 *
	 * &lt;input type=&quot;text&quot;/&gt; &lt;img src=&quot;#URL&quot; alt=&quot;image&quot;&gt;
	 *
	 * Jsoup considers &lt;input&gt; and &lt;input/&gt; as self closing tags.
	 *
	 * Consequently, they should not have children.
	 *
	 * But there is something weird with Jsoup, &lt;input&gt; could have children if there
	 * is another html tag close to its position, this behavior is incorrect.
	 * &lt;input/&gt; could not, this is correct.
	 *
	 * How could you verify that ? Just run the tests and look the logs.
	 *
	 * Here is the previous code with self closing tag issue :
	 * https://github.com/osscameroon/js-generator/tree/self-closing-tag-issue
	 *
	 * In order to correct that, we created a condition to test if the tag is self
	 * closing then we do nothing. If it is not self closing and if there are
	 * children, only then we append children.
	 *
	 * Before this change, the only condition was if the element has children. This
	 * is why we had self closing tag with the possibility of having children,
	 * that's completely wrong.
	 *
	 * Useful links:
	 *
	 * https://www.educba.com/types-of-tags-in-html/
	 *
	 * https://www.tutorialstonight.com/self-closing-tags-in-html.php#:~:text=HTML%
	 * 20Self%20Closing%20Tag,%2C%20etc.
	 *
	 */

<span class="fc bfc" id="L385" title="All 2 branches covered.">	boolean hasChld = jsElement.getElement().childrenSize() &gt; 0;</span>

<span class="fc" id="L387">	logger.log(Level.INFO, &quot; **** METHOD -- appendChild(JsElement jsElement) --  Analyzing jsElement :&quot;</span>
<span class="fc" id="L388">		+ jsElement.getElement().tag().getName() + &quot; -&gt; isEmpty : &quot; + jsElement.getElement().tag().isEmpty()</span>
<span class="fc" id="L389">		+ &quot; -&gt; isSelfClosing : &quot; + jsElement.getElement().tag().isSelfClosing() + &quot; -&gt; isKnown : &quot;</span>
<span class="fc" id="L390">		+ Tag.isKnownTag(jsElement.getElement().tagName().replace(&quot;_&quot;, &quot;&quot;)) + &quot; -&gt; hasChild : &quot; + hasChld</span>
		+ &quot; **** &quot; + &quot;\n&quot; + &quot;---------------&quot; + &quot;\n&quot;);

<span class="fc" id="L393">	logger.log(Level.INFO,</span>
		&quot; **** METHOD -- appendChild(JsElement jsElement) --  Analyzing jsElement childNodes : tagName = &quot;
<span class="fc" id="L395">			+ jsElement.getElement().tagName() + &quot; -&gt; &quot; + jsElement.getElement()</span>
<span class="fc" id="L396">			+ &quot; -&gt;  List of child Nodes -&gt; &quot; + jsElement.getElement().childNodes() + &quot;\n&quot;</span>
			+ &quot;---------------&quot; + &quot;\n&quot;);

<span class="fc" id="L399">	logger.log(Level.INFO,</span>
		&quot; **** METHOD -- appendChild(JsElement jsElement) --  Analyzing jsElement children : tagName = &quot;
<span class="fc" id="L401">			+ jsElement.getElement().tagName() + &quot; -&gt; &quot; + jsElement.getElement()</span>
<span class="fc" id="L402">			+ &quot; -&gt;  List of children -&gt; &quot; + jsElement.getElement().children() + &quot;\n&quot; + &quot;---------------&quot;</span>
			+ &quot;\n&quot;);

	// tag name
<span class="fc" id="L406">	String tag = jsElement.getElement().tagName();</span>

	// If the tag is not self closing

<span class="fc bfc" id="L410" title="All 2 branches covered.">	if (!jsElement.getElement().tag().isSelfClosing()) {</span>

<span class="fc bfc" id="L412" title="All 2 branches covered.">	    if (jsElement.getElement().childNodes().size() &gt; 0) {</span>

<span class="fc bfc" id="L414" title="All 2 branches covered.">		for (Node childNode : jsElement.getElement().childNodes()) {</span>

<span class="fc bfc" id="L416" title="All 2 branches covered.">		    if (childNode instanceof Element) {</span>

<span class="fc" id="L418">			Element childElement = (Element) childNode;</span>

<span class="fc" id="L420">			generatedCode.append(jsElement.getElement().tagName()).append(&quot;.appendChild(&quot;)</span>
<span class="fc" id="L421">				.append(childElement.tagName()).append(&quot;);\n&quot;);</span>

		    }

		    // text nodes: text nodes of the element (content in between tags)

<span class="fc bfc" id="L427" title="All 2 branches covered.">		    if (childNode instanceof TextNode) {</span>

<span class="fc" id="L429">			TextNode textNode = (TextNode) childNode;</span>

			/*
			 * We concat trailing space because trim() removes all leading and trailing
			 * spaces even the ones that are mandatory.
			 *
			 */

<span class="fc bfc" id="L437" title="All 2 branches covered.">			if (!textNode.isBlank()) {</span>
<span class="fc" id="L438">			    generatedCode.append(tag).append(&quot;.appendChild(document.createTextNode(\&quot;&quot;)</span>
<span class="fc" id="L439">				    .append(textNode.toString().replace(&quot;\n&quot;, &quot;&quot;).trim().concat(&quot; &quot;)).append(&quot;\&quot;));\n&quot;);</span>
			}

		    }

<span class="fc" id="L444">		}</span>

	    }

	}

<span class="fc" id="L450">	return generatedCode.toString();</span>
    }

    /**
     * Given an html file's name, it verifies if the name is correct or not
     *
     * @param htmlFileName HTML file's name
     *
     * @return true if the name is correct; false otherwise
     */

    /*
     * https://www.javacodeexamples.com/java-regex-validate-file-name-extension/3504
     *
     * - Start of the string [a-zA-Z0-9._-] - Any character between a to z or A to
     * Z, any digit between 0 to 9, a dot, an underscore, a hyphen One or more times
     * - Followed by a . (html) - &quot;html&quot; - End of the string
     *
     * .html FALSE / test FALSE
     *
     */

    protected boolean isHTMLFileNameCorrect(String htmlFileName) {

<span class="fc" id="L474">	String regex = &quot;^[a-zA-Z0-9._-]+\\.(html)$&quot;;</span>

<span class="fc" id="L476">	return htmlFileName.matches(regex);</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>