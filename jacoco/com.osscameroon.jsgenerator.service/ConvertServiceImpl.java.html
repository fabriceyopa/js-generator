<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ConvertServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jsgenerator</a> &gt; <a href="index.source.html" class="el_package">com.osscameroon.jsgenerator.service</a> &gt; <span class="el_source">ConvertServiceImpl.java</span></div><h1>ConvertServiceImpl.java</h1><pre class="source lang-java linenums">package com.osscameroon.jsgenerator.service;

import static com.osscameroon.jsgenerator.util.Constants.HTML_SRC_DIR;
import static com.osscameroon.jsgenerator.util.Constants.JS_DEST_DIR;

import java.io.File;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.List;
import java.util.logging.Level;
import java.util.logging.Logger;

import org.jsoup.Jsoup;
import org.jsoup.nodes.Attribute;
import org.jsoup.nodes.Attributes;
import org.jsoup.nodes.Element;
import org.jsoup.nodes.TextNode;
import org.jsoup.parser.Parser;
import org.jsoup.parser.Tag;

import com.osscameroon.jsgenerator.exception.DuplicatedHTMLFileNameException;
import com.osscameroon.jsgenerator.exception.EmptyHTMLFilesListException;
import com.osscameroon.jsgenerator.exception.HTMLFileNotFoundException;
import com.osscameroon.jsgenerator.exception.HTMLUnknownElementException;
import com.osscameroon.jsgenerator.exception.IncorrectHTMLFileNameException;
import com.osscameroon.jsgenerator.exception.NoHTMLCodeException;
import com.osscameroon.jsgenerator.exception.NoHTMLFileNameException;
import com.osscameroon.jsgenerator.model.JsElement;
import com.osscameroon.jsgenerator.model.JsVariableDeclaration;
import com.osscameroon.jsgenerator.util.FileUtil;

/**
 * Provides an implementation of {@link ConvertService} interface.
 *
 * @author Fanon Jupkwo
 * @author Elroy Kanye
 *
 */
public class ConvertServiceImpl implements ConvertService {

<span class="fc" id="L42">    private static final Logger logger = Logger.getLogger(ConvertServiceImpl.class.getName());</span>

    private JsVariableDeclaration jsVariableDeclaration;

<span class="fc" id="L46">    public ConvertServiceImpl(JsVariableDeclaration jsVariableDeclaration) {</span>

<span class="fc" id="L48">	this.jsVariableDeclaration = jsVariableDeclaration;</span>

<span class="fc" id="L50">    }</span>

    /**
     * Tags present in the document to convert
     */

<span class="fc" id="L56">    private List&lt;String&gt; usedTags = new ArrayList&lt;&gt;();</span>

    /**
     * {@inheritDoc}
     *
     *
     */

    @Override
    public String convert(String content) throws NoHTMLCodeException {

<span class="pc bpc" id="L67" title="1 of 2 branches missed.">	if (content == null) {</span>

<span class="nc" id="L69">	    throw new NoHTMLCodeException(&quot;There is no html content.&quot;);</span>
	}

<span class="pc bpc" id="L72" title="1 of 2 branches missed.">	if (content.isBlank()) {</span>

<span class="nc" id="L74">	    throw new NoHTMLCodeException(&quot;The content has nothing to translate.&quot;);</span>

	}

<span class="fc" id="L78">	Element htmlDoc = Jsoup.parse(content, &quot;&quot;, Parser.xmlParser());</span>

	/*
	 * trim() is added to delete leading and trailing space. Before adding that, the
	 * generated Js code contained these not important spaces. It was difficult to
	 * test this method.
	 */

<span class="fc" id="L86">	String result = parseElement(htmlDoc).trim();</span>

	/*
	 * Without this line, the result of convert method with same parameter changed
	 * everytime if we used the same object to call this function. The result of
	 * convert with same parameter was constant if we used different objects. To
	 * avoid this issue, we were forced to create different objects but that's not
	 * how it should be done.
	 *
	 * Now, the program clears the list of used tags in order to always get an empty
	 * list when we call this method.
	 */
<span class="fc" id="L98">	usedTags.clear();</span>

<span class="fc" id="L100">	return result;</span>
    }

    /**
     * {@inheritDoc}
     *
     *
     */

    @Override
    public void convertHtmlFiletoJsFileFromCommandLineInterface(String htmlFileName)
	    throws NoHTMLFileNameException, IncorrectHTMLFileNameException, HTMLFileNotFoundException {

<span class="nc bnc" id="L113" title="All 2 branches missed.">	if (htmlFileName == null) {</span>

<span class="nc" id="L115">	    throw new NoHTMLFileNameException(&quot;There is no Html file name.&quot;);</span>
	}

<span class="nc bnc" id="L118" title="All 2 branches missed.">	if (!isHTMLFileNameCorrect(htmlFileName)) {</span>

<span class="nc" id="L120">	    throw new IncorrectHTMLFileNameException(&quot;The HTML file's name \&quot;&quot; + htmlFileName + &quot;\&quot; is incorrect.&quot;);</span>
	}

	// get the full supposed path to the html file

<span class="nc" id="L125">	String pathToHtml = HTML_SRC_DIR.getFolder().concat(htmlFileName);</span>

<span class="nc" id="L127">	File htmlFile = new File(pathToHtml);</span>

<span class="nc bnc" id="L129" title="All 2 branches missed.">	if (!htmlFile.exists()) {</span>

<span class="nc" id="L131">	    throw new HTMLFileNotFoundException(&quot;Html file \&quot;&quot; + htmlFileName + &quot;\&quot; not found&quot;);</span>
	}

	// Use log instead of system.out.println to show steps

	/*
	 * If HTML_SRC_DIR folder doesn't exist then it will create them
	 *
	 * new File(HTML_SRC_DIR.getFolder()).createNewFile();
	 */

<span class="nc" id="L142">	logger.log(Level.INFO, &quot; **** Converting &quot; + htmlFileName + &quot; to js file **** &quot;);</span>

	/*
	 * By default, the input folder exists but the output folder don't. So, if
	 * JS_DEST_DIR folder doesn't exist then it will be created in order to receive
	 * generated Js files. If this output folder doesn't exist when this method is
	 * called, an exception will be thrown.
	 */

<span class="nc" id="L151">	File outputFolder = new File(JS_DEST_DIR.getFolder());</span>

<span class="nc bnc" id="L153" title="All 4 branches missed.">	if (outputFolder.exists() &amp;&amp; outputFolder.isDirectory()) {</span>

	} else {

<span class="nc" id="L157">	    outputFolder.mkdir();</span>
	}

	// get the full supposed path to the js file

<span class="nc" id="L162">	String jsFilePath = JS_DEST_DIR.getFolder().concat(htmlFileName.split(&quot;.html&quot;)[0] + &quot;.js&quot;);</span>

<span class="nc" id="L164">	String htmlContent = FileUtil.readHtmlFile(pathToHtml).toString();</span>

<span class="nc" id="L166">	String jsContent = convert(htmlContent);</span>

<span class="nc" id="L168">	FileUtil.writeJsFile(jsContent, jsFilePath);</span>

<span class="nc" id="L170">	logger.log(Level.INFO, &quot; **** Conversion complete **** &quot;);</span>

<span class="nc" id="L172">    }</span>

    /**
     * {@inheritDoc}
     *
     *
     */

    @Override
    public void convertHtmlFiletoJsFileFromCommandLineInterface(String[] args)
	    throws NoHTMLFileNameException, EmptyHTMLFilesListException, DuplicatedHTMLFileNameException {

<span class="nc bnc" id="L184" title="All 2 branches missed.">	if (args == null) {</span>

<span class="nc" id="L186">	    throw new NoHTMLFileNameException(&quot;There is no list of Html files.&quot;);</span>

	}

<span class="nc bnc" id="L190" title="All 2 branches missed.">	if (args.length == 0) {</span>

<span class="nc" id="L192">	    throw new EmptyHTMLFilesListException(&quot;The list of Html files to translate is empty&quot;);</span>
	}

<span class="nc" id="L195">	List&lt;String&gt; argList = Arrays.asList(args);</span>

	// TODO: verify that all files are named correctly with .html, create a method
	// in ConvertService

	// throw exception because there are list 2 files with same name
	// inform the user and work with unique file names

<span class="nc" id="L203">	argList.stream().forEach(s -&gt; {</span>

<span class="nc bnc" id="L205" title="All 2 branches missed.">	    if (Collections.frequency(argList, s) == 1) {</span>

<span class="nc" id="L207">		convertHtmlFiletoJsFileFromCommandLineInterface(s);</span>

	    } else {

		// TODO: throw exception because there are 2 files with same name

<span class="nc" id="L213">		logger.log(Level.INFO, &quot;There are at least 2 files with same name on CLI : &quot; + s);</span>

<span class="nc" id="L215">		throw new DuplicatedHTMLFileNameException(&quot;There are at least 2 files with same name on CLI : &quot; + s);</span>

	    }
<span class="nc" id="L218">	});</span>

<span class="nc" id="L220">    }</span>

    /**
     * {@inheritDoc}
     *
     *
     */

    // Will be implemented soon

    @Override
    public void convertHtmlFiletoJsFileFromWeb(String htmlFileName, String outputFolder) {
<span class="nc" id="L232">	throw new UnsupportedOperationException();</span>
    }

    /**
     * Goes through the Jsoup Elements and converts them to JsElement objects.
     *
     * @param element Jsoup Element
     * @return the generated code in JS
     *
     */

    private String parseElement(Element element) {

<span class="fc" id="L245">	StringBuilder generatedCode = new StringBuilder();</span>

<span class="fc bfc" id="L247" title="All 2 branches covered.">	for (Element child : element.children()) {</span>
<span class="fc" id="L248">	    generatedCode.append(parseElement(child)).append(&quot;\n&quot;); // recursive</span>

<span class="fc" id="L250">	    JsElement parent = new JsElement(child, jsVariableDeclaration);</span>

<span class="fc" id="L252">	    generatedCode.append(parse(usedTags, parent));</span>

	    // parse this current element

<span class="fc" id="L256">	    String appends = appendChild(parent); // append this current element's children code to parent code</span>

<span class="fc bfc" id="L258" title="All 2 branches covered.">	    if (!appends.equals(&quot;&quot;)) {</span>
<span class="fc" id="L259">		generatedCode.append(appends);</span>
	    }
<span class="fc" id="L261">	}</span>
<span class="fc" id="L262">	return generatedCode.toString();</span>
    }

//	WITH USED TAGS LIST

    /**
     * For this element, it returns the code to append the element to the parent
     *
     * @param usedTags  List of used tags in the document
     * @param jsElement
     * @return code to append the element to the parent
     * @throws HTMLUnknownElementException if an invalid HTML tag is used
     */

    private String parse(List&lt;String&gt; usedTags, JsElement jsElement) throws HTMLUnknownElementException {

<span class="fc bfc" id="L278" title="All 2 branches covered.">	if (!jsElement.getElement().tag().isKnownTag()) {</span>

<span class="fc" id="L280">	    throw new HTMLUnknownElementException(</span>
<span class="fc" id="L281">		    &quot;\&quot;&quot; + jsElement.getElement().tagName() + &quot;\&quot;&quot; + &quot; is not a valid HTML Element.&quot;);</span>
	}

	// attributes: attributes of the element
<span class="fc" id="L285">	Attributes attributes = jsElement.getElement().attributes();</span>

	// text nodes: text nodes of the element (content in between tags)
<span class="fc" id="L288">	List&lt;TextNode&gt; innerHTML = jsElement.getElement().textNodes();</span>

	// search tag name among used tags
<span class="fc" id="L291">	usedTags.stream().filter(s -&gt; s.equals(jsElement.getElement().tagName()))</span>
<span class="fc" id="L292">		.forEach(s -&gt; jsElement.getElement().tagName(jsElement.getElement().tagName() + &quot;_&quot;));</span>

	// tag name
<span class="fc" id="L295">	String tag = jsElement.getElement().tagName();</span>

<span class="fc" id="L297">	usedTags.add(tag);</span>

	/*
	 * Tag name should not contain _ TODO: Check that
	 */

<span class="fc" id="L303">	StringBuilder generatedCode = new StringBuilder(jsElement.getJsVariableDeclaration().getKeyword() + &quot; &quot; + tag</span>
<span class="fc" id="L304">		+ &quot; = document.createElement(\&quot;&quot; + tag.replace(&quot;_&quot;, &quot;&quot;) + &quot;\&quot;);\n&quot;);</span>

<span class="fc" id="L306">	return addAttributeToElement(attributes, innerHTML, tag, generatedCode);</span>
    }

    /*
     * TODO: We have to add the update info (date, author,...) everywhere when it is
     * needed
     */

    private String appendChild(JsElement jsElement) {

<span class="fc" id="L316">	StringBuilder generatedCode = new StringBuilder();</span>

	/*
	 * Please, think twice before deleting this log, it helps to understand what is
	 * going on under the hood. It is really helpful to understand that there is a
	 * bug in Jsoup library.
	 *
	 * Let's take an example,
	 *
	 *
	 * &lt;input type=&quot;text&quot;&gt; &lt;img src=&quot;#URL&quot; alt=&quot;image&quot;&gt;
	 *
	 * ------------------------------------------------------
	 *
	 * &lt;input type=&quot;text&quot;/&gt; &lt;img src=&quot;#URL&quot; alt=&quot;image&quot;&gt;
	 *
	 * Jsoup considers &lt;input&gt; and &lt;input/&gt; as self closing tags.
	 *
	 * Consequently, they should not have children.
	 *
	 * But there is something weird with Jsoup, &lt;input&gt; could have children if there
	 * is another html tag close to its position, this behavior is incorrect.
	 * &lt;input/&gt; could not, this is correct.
	 *
	 * How could you verify that ? Just run the tests and look the logs.
	 *
	 * Here is the previous code with self closing tag issue :
	 * https://github.com/osscameroon/js-generator/tree/self-closing-tag-issue
	 *
	 * In order to correct that, we created a condition to test if the tag is self
	 * closing then we do nothing. If it is not self closing and if there are
	 * children, only then we append children.
	 *
	 * Before this change, the only condition was if the element has children. This
	 * is why we had self closing tag with the possibility of having children,
	 * that's completely wrong.
	 *
	 * Useful links:
	 *
	 * https://www.educba.com/types-of-tags-in-html/
	 *
	 * https://www.tutorialstonight.com/self-closing-tags-in-html.php#:~:text=HTML%
	 * 20Self%20Closing%20Tag,%2C%20etc.
	 *
	 */

<span class="fc bfc" id="L362" title="All 2 branches covered.">	boolean hasChld = jsElement.getElement().childrenSize() &gt; 0;</span>

<span class="fc" id="L364">	logger.log(Level.INFO,</span>
<span class="fc" id="L365">		&quot; **** Analyze jsElement :&quot; + jsElement.getElement().tag().getName() + &quot; -&gt; isEmpty : &quot;</span>
<span class="fc" id="L366">			+ jsElement.getElement().tag().isEmpty() + &quot; -&gt; isSelfClosing : &quot;</span>
<span class="fc" id="L367">			+ jsElement.getElement().tag().isSelfClosing() + &quot; -&gt; isKnown : &quot;</span>
<span class="fc" id="L368">			+ Tag.isKnownTag(jsElement.getElement().tagName().replace(&quot;_&quot;, &quot;&quot;)) + &quot; -&gt; hasChild : &quot;</span>
			+ hasChld + &quot; **** &quot;);

<span class="fc bfc" id="L371" title="All 4 branches covered.">	if (!jsElement.getElement().tag().isSelfClosing() &amp;&amp; jsElement.getElement().children().size() &gt; 0) {</span>

<span class="fc bfc" id="L373" title="All 2 branches covered.">	    for (Element child : jsElement.getElement().children()) {</span>

<span class="fc" id="L375">		generatedCode.append(jsElement.getElement().tagName()).append(&quot;.appendChild(&quot;).append(child.tagName())</span>
<span class="fc" id="L376">			.append(&quot;);\n&quot;);</span>
<span class="fc" id="L377">	    }</span>
	}

<span class="fc" id="L380">	return generatedCode.toString();</span>
    }

    /**
     * Given an element, it adds the attributes to the element
     *
     * @param attributes    Attributes of the element
     * @param innerHTML     Text nodes of the element
     * @param tag           Tag name of the element
     * @param generatedCode Code generated in JS
     * @return generated code for the element
     */
    private String addAttributeToElement(Attributes attributes, List&lt;TextNode&gt; innerHTML, String tag,
	    StringBuilder generatedCode) {
<span class="fc bfc" id="L394" title="All 2 branches covered.">	for (Attribute attribute : attributes) {</span>
<span class="fc" id="L395">	    generatedCode.append(tag).append(&quot;.setAttribute(\&quot;&quot;).append(attribute.getKey()).append(&quot;\&quot;, \&quot;&quot;)</span>
<span class="fc" id="L396">		    .append(attribute.getValue()).append(&quot;\&quot;);\n&quot;);</span>
<span class="fc" id="L397">	}</span>

<span class="fc bfc" id="L399" title="All 2 branches covered.">	for (TextNode textNode : innerHTML) {</span>
<span class="fc bfc" id="L400" title="All 2 branches covered.">	    if (!textNode.isBlank()) {</span>
<span class="fc" id="L401">		generatedCode.append(tag).append(&quot;.appendChild(document.createTextNode(\&quot;&quot;)</span>
<span class="fc" id="L402">			.append(textNode.toString().replace(&quot;\n&quot;, &quot;&quot;).trim()).append(&quot;\&quot;));\n&quot;);</span>
	    }
<span class="fc" id="L404">	}</span>

<span class="fc" id="L406">	return generatedCode.toString();</span>
    }

    /**
     * Given an html file's name, it verifies if the name is correct or not
     *
     * @param htmlFileName HTML file's name
     *
     * @return true if the name is correct; false otherwise
     */

    /*
     * https://www.javacodeexamples.com/java-regex-validate-file-name-extension/3504
     *
     * - Start of the string [a-zA-Z0-9._-] - Any character between a to z or A to
     * Z, any digit between 0 to 9, a dot, an underscore, a hyphen One or more times
     * - Followed by a . (html) - &quot;html&quot; - End of the string
     *
     * .html FALSE / test FALSE
     *
     */

    protected boolean isHTMLFileNameCorrect(String htmlFileName) {

<span class="fc" id="L430">	String regex = &quot;^[a-zA-Z0-9._-]+\\.(html)$&quot;;</span>

<span class="fc" id="L432">	return htmlFileName.matches(regex);</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>